<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>2048 Pro ‚Äî –∫–æ–º–ø–∞–∫—Ç</title>
<style>
  :root{
    --bg:#f6f2e9; --panel:#ffffff; --grid:#cbbfb3; --cell:#d6ccc2;
    --text:#5a524a; --muted:#8f877f; --chip:#efe7dd; --chipText:#4e453e;
    --shadow:0 8px 22px rgba(0,0,0,.12); --border:rgba(0,0,0,.08);
  }
  [data-theme="dark"]{
    --bg:#0b0f1a; --panel:#101627; --grid:#151b36; --cell:#11162f;
    --text:#e8ebff; --muted:#9aa4bf; --chip:#151c32; --chipText:#e8ebff;
    --shadow:0 10px 30px rgba(0,0,0,.35); --border:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1200px 600px at 10% -10%, var(--panel) 0%, var(--bg) 60%, var(--bg) 100%);
    color:var(--text); font-family: -apple-system, Segoe UI, Roboto, Inter, Arial, system-ui, sans-serif;
    -webkit-tap-highlight-color: transparent; overscroll-behavior:none;
  }

  /* ‚Äî‚Äî‚Äî –ó–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äî‚Äî‚Äî */
  .brand{
    max-width:920px; margin:10px auto 4px; padding:0 10px;
    display:flex; align-items:center; gap:10px;
  }
  .logo{
    width:28px; height:28px; display:inline-block;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,.2));
  }
  .title{font-size:28px; font-weight:900; letter-spacing:.2px}
  .pill{
    margin-left:6px; padding:2px 10px; border-radius:999px; font-size:14px; font-weight:800; color:#3a2a00;
    background:linear-gradient(135deg,#ffd079,#ffb24a); box-shadow:0 4px 12px rgba(255,153,0,.35), inset 0 1px 0 rgba(255,255,255,.6);
  }

  /* ‚Äî‚Äî‚Äî –ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ 3-—Å—Ç—Ä–æ—á–Ω–æ–µ –º–µ–Ω—é ‚Äî‚Äî‚Äî */
  header{max-width:920px; margin:0 auto; padding:6px 10px}
  .menu{display:flex; flex-direction:column; gap:4px; font-size:14px}
  .row{display:flex; gap:6px; align-items:center}
  .grow{flex:1}
  .btn, .select, .check, .stat{
    border:1px solid var(--border); background:var(--panel); color:var(--text);
    padding:8px 10px; border-radius:10px; font-weight:700; box-shadow:var(--shadow);
    display:flex; align-items:center; justify-content:center; white-space:nowrap; min-height:36px
  }
  .btn:active{transform:translateY(1px)}
  .ghost{background:var(--chip); color:var(--chipText)}
  .select{padding:0 10px}
  .select select{
    appearance:none; background:transparent; border:0; padding:8px 0; font:inherit; color:inherit;
  }
  .check{gap:6px; padding:6px 10px}
  .check input{transform:scale(1.05)}
  .stat{justify-content:space-between; padding:6px 10px; font-weight:800}
  .stat small{opacity:.75; font-weight:700}

  main{max-width:920px; margin:0 auto; padding:6px 10px 12px; display:grid; place-items:center}
  .wrap{
    width:100%; max-width:620px; aspect-ratio:1/1; position:relative; padding:10px;
    background:var(--panel); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow)
  }
  .grid{position:absolute; inset:10px; padding:8px; background:var(--grid); border-radius:12px; display:grid; gap:8px}
  .cell{background:var(--cell); border-radius:9px; box-shadow: inset 0 1px 0 rgba(255,255,255,.28)}
  [data-theme="dark"] .cell{box-shadow: inset 0 1px 0 rgba(255,255,255,.06)}
  .tiles{position:absolute; inset:18px; pointer-events:none}

  /* –¢–ï–ù–¨ –ò –û–ë–™–Å–ú –ü–õ–ò–¢–û–ö */
  .tile{
    position:absolute; display:flex; align-items:center; justify-content:center; user-select:none;
    width:var(--cellw); height:var(--cellh); border-radius:10px; font-weight:900; font-size:28px;
    transform: translate(var(--x), var(--y)) scale(1); transition: transform 0.9s cubic-bezier(0.25, 1, 0.5, 1) ease;
    color:#776e65; background:#eee4da;
    /* –æ–±—ä—ë–º–Ω—ã–µ —Ç–µ–Ω–∏: –ø–∞–¥–∞—é—â–∞—è + –º—è–≥–∫–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∫–∞–π–º–∞ */
    box-shadow:
      0 14px 28px rgba(0,0,0,.18),
      0 4px 10px rgba(0,0,0,.12),
      inset 0 1px 2px rgba(255,255,255,.55);
  }
  .tile.pop{animation:pop .14s ease-out both}
  @keyframes pop{0%{transform:translate(var(--x),var(--y)) scale(.85)}100%{transform:translate(var(--x),var(--y)) scale(1)}}

  /* –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ —Ü–≤–µ—Ç–∞ */
  .v2{background:#eee4da;color:#776e65}.v4{background:#ede0c8;color:#776e65}
  .v8{background:#f2b179;color:#f9f6f2}.v16{background:#f59563;color:#f9f6f2}
  .v32{background:#f67c5f;color:#f9f6f2}.v64{background:#f65e3b;color:#f9f6f2}
  .v128{background:#edcf72;color:#f9f6f2;font-size:24px}.v256{background:#edcc61;color:#f9f6f2;font-size:24px}
  .v512{background:#edc850;color:#f9f6f2;font-size:24px}.v1024{background:#edc53f;color:#f9f6f2;font-size:22px}
  .v2048{background:#edc22e;color:#f9f6f2;font-size:22px}.v4096,.v8192{background:#3c3a32;color:#f9f6f2;font-size:22px}

  .toast{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) scale(.95); background:rgba(0,0,0,.35);
         padding:10px 12px; border-radius:10px; color:#fff; box-shadow:var(--shadow); opacity:0; transition:.15s; pointer-events:none; font-size:14px}
  .toast.show{opacity:1; transform:translate(-50%,-50%) scale(1)}
  footer{padding:8px 10px 12px; color:var(--muted); font-size:12px; text-align:center}

  @media (max-width:420px){
    .btn,.select,.check,.stat{min-height:34px; padding:6px 8px; font-size:13px}
    .tile{font-size:24px}
  }

/* --- Premium Smooth Animations --- */
.tile {
  transition: transform  0.9s cubic-bezier(0.25, 1, 0.5, 1) cubic-bezier(0.22, 1, 0.36, 1);
}

.tile.new-tile {
  animation: appear-premium 0.4s ease-out;
}

.tile.merge-tile {
  animation: merge-premium 0.35s ease-in-out;
}

@keyframes appear-premium {
  0% {
    transform: scale(0.6);
    opacity: 0;
  }
  60% {
    transform: scale(1.05);
    opacity: 1;
  }
  100% {
    transform: scale(1);
  }
}

@keyframes merge-premium {
  0% {
    transform: scale(1);
  }
  40% {
    transform: scale(1.12);
  }
  100% {
    transform: scale(1);
  }
}

/* === –ê–Ω–∏–º–∞—Ü–∏–∏ –∏–∑ WOW –≤–µ—Ä—Å–∏–∏ === */
@keyframes ambient{
  0%{filter:saturate(1) brightness(1)}
@keyframes spawn{
  0%{transform:scale(.4); filter:blur(4px); box-shadow:0 0 0 rgba(0,0,0,0)}
@keyframes mergePulse{
  0%{transform:scale(.98); box-shadow:0 0 0 0 rgba(255,255,255,.0)}
@keyframes wobble{
  0%{transform:rotate(0) scale(1)}
@keyframes sheen{
  0%{opacity:.0; background-position:120% 0}
@keyframes bounce{
  0%{transform:translateY(0)}
.spawn{
  animation: spawn var(--spawn-duration) cubic-bezier(.16,.86,.22,1) both;
}
.merged{
  animation: mergePulse var(--merge-duration) cubic-bezier(.2,.7,.1,1) both;
}
.tile{
  animation: wobble var(--wobble-duration) ease both;
}
.chain{
  animation-delay: calc(var(--delay, 0) * 50ms);
}
.bounce{animation:bounce 620ms ease}
</style>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ -->
<link rel="manifest" href="manifest.json">

<!-- –¶–≤–µ—Ç —Ç–µ–º—ã -->
<meta name="theme-color" content="#f2b179">

<!-- –ò–∫–æ–Ω–∫–∞ –¥–ª—è iOS -->
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Favicon -->
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">


<style>
.tile {
  position: absolute;
  transition: transform  0.9s cubic-bezier(0.25, 1, 0.5, 1) cubic-bezier(0.22, 1, 0.36, 1); /* –ø–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å –ª—ë–≥–∫–∏–º –ø–æ–¥–ø—Ä—É–∂–∏–Ω–∏–≤–∞–Ω–∏–µ–º */
}

.tile.new-tile {
  animation: appear 0.25s ease-out;
}

.tile.merge-tile {
  animation: merge 0.25s ease-in-out;
}

@keyframes appear {
  0% {
    transform: scale(0);
    opacity: 0;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

@keyframes merge {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.12);
  }
  100% {
    transform: scale(1);
  }
}
</style>


<style>
@keyframes wobble {
  0% { transform: translateX(0); }
  15% { transform: translateX(-2px) rotate(-1deg); }
  30% { transform: translateX(2px) rotate(1deg); }
  45% { transform: translateX(-1px) rotate(-1deg); }
  60% { transform: translateX(1px) rotate(1deg); }
  75% { transform: translateX(-1px) rotate(-1deg); }
  100% { transform: translateX(0); }
}
.tile.wobble {
  animation: wobble 0.35s ease;
}
.tile.merge-wobble {
  animation: wobble 0.45s ease;
}
</style>

</head>
<body>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
<div class="brand" aria-hidden="true">
  <!-- –ø—Ä–æ—Å—Ç–∞—è SVG-–∏–∫–æ–Ω–∫–∞ –º–∏—à–µ–Ω–∏ -->
  <svg class="logo" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
    <defs><radialGradient id="g" cx="50%" cy="50%" r="50%">
      <stop offset="0" stop-color="#ff6a6a"/><stop offset="1" stop-color="#e51d2d"/>
    </radialGradient></defs>
    <circle cx="24" cy="24" r="22" fill="url(#g)"/>
    <circle cx="24" cy="24" r="15" fill="#fff" opacity=".9"/>
    <circle cx="24" cy="24" r="9" fill="url(#g)"/>
    <circle cx="24" cy="24" r="3.2" fill="#fff"/>
  </svg>
  <div class="title">2048 <span class="pill">Pro</span></div>
</div>

<header>
  <div class="menu">
    <!-- –°—Ç—Ä–æ–∫–∞ 1 -->
    <div class="row">
      <button id="undo" class="btn ghost grow" title="–û—Ç–º–µ–Ω–∏—Ç—å —Ö–æ–¥">‚Ü© –û—Ç–º–µ–Ω–∏—Ç—å</button>
      <button id="themeBtn" class="btn ghost grow" title="–°–≤–µ—Ç–ª–∞—è/—Ç—ë–º–Ω–∞—è —Ç–µ–º–∞">üåì –¢–µ–º–∞</button>
      <button id="musicBtn" class="btn ghost grow" title="–§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞">üîä –ú—É–∑—ã–∫–∞</button>
    </div>
    <!-- –°—Ç—Ä–æ–∫–∞ 2 -->
    <div class="row">
      <div class="select grow">
        <label>–†–∞–∑–º–µ—Ä:
          <select id="sizeSel" aria-label="–†–∞–∑–º–µ—Ä –ø–æ–ª—è">
            <option>4√ó4</option><option>5√ó5</option><option>6√ó6</option>
          </select>
        </label>
      </div>
      <label class="check grow" title="–ë–µ–∑ –æ—Ç–º–µ–Ω—ã —Ö–æ–¥–∞"><input id="hardcore" type="checkbox" /> –•–∞—Ä–¥–∫–æ—Ä</label>
      <button id="newGame" class="btn grow" title="–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ">‚Üª –ù–æ–≤–∞—è</button>
    </div>
    <!-- –°—Ç—Ä–æ–∫–∞ 3 -->
    <div class="row">
      <div class="stat grow"><small>–û—á–∫–∏</small><span id="score">0</span></div>
      <div class="stat grow"><small>–†–µ–∫–æ—Ä–¥</small><span id="best">0</span></div>
    </div>
  </div>
</header>

<main>
  <div class="wrap" id="wrap">
    <div class="grid" id="grid" aria-hidden="true"></div>
    <div class="tiles" id="tiles" role="grid" aria-label="–ü–æ–ª–µ 2048"></div>
    <div class="toast" id="toast">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</div>
  </div>
</main>

<footer>2048 Pro ¬© 2014-2025 Ray_Production. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</footer>

<script>
(()=> {
  /* ===== DOM ===== */
  const tilesEl=document.getElementById('tiles'), gridBg=document.getElementById('grid'), wrap=document.getElementById('wrap');
  const scoreEl=document.getElementById('score'), bestEl=document.getElementById('best'), toast=document.getElementById('toast');
  const btnNew=document.getElementById('newGame'), btnUndo=document.getElementById('undo'), themeBtn=document.getElementById('themeBtn');
  const sizeSel=document.getElementById('sizeSel'), hardcoreCb=document.getElementById('hardcore');
  const musicBtn=document.getElementById('musicBtn');

  /* ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===== */
  let N = +(localStorage.getItem('size2048')||4);
  let hardcore = localStorage.getItem('hardcore2048')==='1';
  sizeSel.selectedIndex = Math.max(0, Math.min(2, N-4));
  hardcoreCb.checked = hardcore;

  /* ===== –ê—É–¥–∏–æ ===== */
  let actx, musicOn=false, sfxOn=true;
  function ensureAudio(){ try{ if(!actx) actx=new (window.AudioContext||window.webkitAudioContext)(); }catch{} }
  function beep({f=440,d=0.06,t='sine',v=0.06}={}){ if(!sfxOn) return; try{ ensureAudio(); const o=actx.createOscillator(), g=actx.createGain(); o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g);g.connect(actx.destination);o.start();g.gain.exponentialRampToValueAtTime(0.0001,actx.currentTime+d);o.stop(actx.currentTime+d);}catch{} }
  const sMove=()=>beep({f:300,d:.05,t:'square',v:.03});
  const sMerge=()=>beep({f:520,d:.08,t:'triangle',v:.05});
  const sOver=()=>beep({f:180,d:.12,t:'sawtooth',v:.06});
  const sWin =()=>{beep({f:660,d:.12}); setTimeout(()=>beep({f:880,d:.12,v:.06}),110)};

  function toggleMusic(){
    ensureAudio();
    if(musicOn){ musicOn=false; musicBtn.textContent='üîä –ú—É–∑—ã–∫–∞'; return; }
    musicOn=true; musicBtn.textContent='üîà –ú—É–∑—ã–∫–∞: –í–ö–õ';
    // –ü—Ä–æ—Å—Ç–∞—è –º–µ–ª–æ–¥–∏—è-–ø–µ—Ç–ª—è
    const bpm=96, beat=60/bpm; let stop=false;
    function loop(){
      if(!musicOn){ stop=true; return; }
      const t0=actx.currentTime;
      const g=actx.createGain(); g.gain.value=0.06; g.connect(actx.destination);
      const scale=[261.63,329.63,392.00,523.25]; // C E G C5
      for(let i=0;i<8;i++){
        const o=actx.createOscillator(), env=actx.createGain();
        o.type='triangle'; o.frequency.value=scale[i%scale.length];
        o.connect(env); env.connect(g);
        const st=t0+i*beat; env.gain.setValueAtTime(0.0001,st);
        env.gain.exponentialRampToValueAtTime(0.12,st+0.01);
        env.gain.exponentialRampToValueAtTime(0.0001,st+beat*0.95);
        o.start(st); o.stop(st+beat*0.96);
      }
      if(!stop) setTimeout(loop, beat*1000*8);
    }
    loop();
  }
  musicBtn.addEventListener('click', toggleMusic);
  ['touchstart','mousedown','keydown'].forEach(ev=>window.addEventListener(ev,()=>ensureAudio(),{once:true,passive:true}));

  /* ===== –ò–≥—Ä–∞ ===== */
  const animMs=900;
  let grid, score=0, best=0, prevState=null, idSeq=1;

  const keyMap={ArrowLeft:'left',a:'left',A:'left',ArrowRight:'right',d:'right',D:'right',ArrowUp:'up',w:'up',W:'up',ArrowDown:'down',s:'down',S:'down'};
  const emptyGrid=()=>Array.from({length:N},()=>Array(N).fill(null));
  const copyGrid=g=>g.map(r=>r.map(t=>t?{...t}:null));
  const gridsEqual=(a,b)=>a.flat().map(t=>t?.value||0).join(',')===b.flat().map(t=>t?.value||0).join(',');
  const bestKey=()=>`best2048_${N}`;

  function computeSizes(){
    gridBg.style.gridTemplateColumns=`repeat(${N},1fr)`; gridBg.style.gridTemplateRows=`repeat(${N},1fr)`; gridBg.innerHTML='';
    for(let i=0;i<N*N;i++){ const c=document.createElement('div'); c.className='cell'; gridBg.appendChild(c); }
    const gap=8, w=tilesEl.clientWidth, h=tilesEl.clientHeight; const cw=(w-gap*(N-1))/N, ch=(h-gap*(N-1))/N;
    tilesEl.style.setProperty('--cellw',cw+'px'); tilesEl.style.setProperty('--cellh',ch+'px');
  }
  function posToPx(x,y){ const gap=8, w=tilesEl.clientWidth, h=tilesEl.clientHeight; const cw=(w-gap*(N-1))/N, ch=(h-gap*(N-1))/N; return [(cw+gap)*x,(ch+gap)*y]; }
  const tileClass=v=> v>=8192?'v8192': v>=4096?'v4096': 'v'+v;

  function mountTiles(g){
    const old=new Map([...tilesEl.children].map(el=>[+el.dataset.id,el])); const next=new Map();
    for(let y=0;y<N;y++)for(let x=0;x<N;x++){
      const t=g[y][x]; if(!t) continue; const id=t.id; let el=old.get(id); const [px,py]=posToPx(x,y);
      if(!el){ el=document.createElement('div'); el.className=`tile ${tileClass(t.value)} pop`; el.dataset.id=id; el.dataset.v=t.value; el.textContent=t.value;
        el.style.setProperty('--x',px+'px'); el.style.setProperty('--y',py+'px'); tilesEl.appendChild(el); }
      else { if(+el.dataset.v!==t.value){ el.className=`tile ${tileClass(t.value)} pop`; el.dataset.v=t.value; el.textContent=t.value; }
             el.style.transition=`transform ${animMs}ms ease`; el.style.setProperty('--x',px+'px'); el.style.setProperty('--y',py+'px'); }
      next.set(id,el);
    }
    for(const [id,el] of old){ if(!next.has(id)){ el.style.transition=`transform ${animMs}ms ease, opacity ${animMs}ms ease`; el.style.opacity='0'; setTimeout(()=>el.remove(),animMs); } }
    scoreEl.textContent=score; if(score>(+localStorage.getItem(bestKey())||0)) localStorage.setItem(bestKey(),String(score));
    best=+localStorage.getItem(bestKey())||0; bestEl.textContent=best;
  }

  function addRandomTile(g){
    const empty=[]; for(let y=0;y<N;y++)for(let x=0;x<N;x++) if(!g[y][x]) empty.push([x,y]);
    if(!empty.length) return false; const [x,y]=empty[Math.floor(Math.random()*empty.length)];
    const fourProb=hardcore?0.5:0.1; g[y][x]={id:idSeq++, value: Math.random()<(1-fourProb)?2:4}; return true;
  }
  function slideRowLeft(row){
    const arr=row.filter(t=>t); let gained=0;
    for(let i=0;i<arr.length-1;i++){ if(arr[i]&&arr[i+1]&&arr[i].value===arr[i+1].value){ arr[i]={id:idSeq++,value:arr[i].value*2}; gained+=arr[i].value; arr[i+1]=null; i++; } }
    const compact=arr.filter(t=>t); while(compact.length<N) compact.push(null); return {row:compact,gained};
  }
  function rotate(g){ const r=Array.from({length:N},()=>Array(N).fill(null)); for(let y=0;y<N;y++)for(let x=0;x<N;x++) r[x][N-1-y]=g[y][x]?{...g[y][x]}:null; return r; }
  function anyMovesLeft(g){
    if(g.flat().some(t=>!t)) return true;
    for(let y=0;y<N;y++)for(let x=0;x<N-1;x++) if(g[y][x]&&g[y][x+1]&&g[y][x].value===g[y][x+1].value) return true;
    for(let y=0;y<N-1;y++)for(let x=0;x<N;x++) if(g[y][x]&&g[y+1][x]&&g[y][x].value===g[y+1][x].value) return true;
    return false;
  }
  const reached2048=g=>g.flat().some(t=>t&&t.value>=2048);

  function move(dir){
    const prev=copyGrid(grid); prevState={grid:prev,score};
    let g=copyGrid(grid), gained=0;
    if(dir==='right'){ g=g.map(r=>r.slice().reverse()); g=g.map(r=>{const s=slideRowLeft(r); gained+=s.gained; return s.row;}); g=g.map(r=>r.slice().reverse()); }
    if(dir==='left'){ g=g.map(r=>{const s=slideRowLeft(r); gained+=s.gained; return s.row;}); }
    if(dir==='up'){ g=rotate(rotate(rotate(g))); g=g.map(r=>{const s=slideRowLeft(r); gained+=s.gained; return s.row;}); g=rotate(g); }
    if(dir==='down'){ g=rotate(g); g=g.map(r=>{const s=slideRowLeft(r); gained+=s.gained; return s.row;}); g=rotate(rotate(rotate(g))); }
    if(gridsEqual(g,grid)) return;
    if(gained>0) sMerge(); else sMove();
    score+=gained; grid=g; mountTiles(grid);
    setTimeout(()=>{ addRandomTile(grid); mountTiles(grid);
      if(reached2048(grid)) sWin();
      if(!anyMovesLeft(grid)){ showToast('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞'); sOver(); }
    }, 100);
  }

  /* ===== –¢–æ—Å—Ç ===== */
  let toastTimer=null; function showToast(t){ toast.textContent=t; toast.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>toast.classList.remove('show'),1400); }

  /* ===== –í–≤–æ–¥ ===== */
  document.addEventListener('keydown',e=>{const d=keyMap[e.key]; if(!d) return; e.preventDefault(); move(d);},{passive:false});
  let touchStart=null;
  wrap.addEventListener('touchstart',e=>{const t=e.changedTouches[0]; touchStart={x:t.clientX,y:t.clientY};},{passive:true});
  wrap.addEventListener('touchend',e=>{ if(!touchStart) return; const t=e.changedTouches[0]; const dx=t.clientX-touchStart.x, dy=t.clientY-touchStart.y; const ax=Math.abs(dx), ay=Math.abs(dy); if(Math.max(ax,ay)<24) return; move(ax>ay?(dx>0?'right':'left'):(dy>0?'down':'up')); touchStart=null;},{passive:true});

  /* ===== –ö–Ω–æ–ø–∫–∏/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ===== */
  btnNew.addEventListener('click',()=>start(true));
  btnUndo.addEventListener('click',()=>{ if(hardcore||!prevState) return; grid=copyGrid(prevState.grid); score=prevState.score; mountTiles(grid); });
  themeBtn.addEventListener('click',()=>{ const dark=document.body.getAttribute('data-theme')==='dark'; if(dark) document.body.removeAttribute('data-theme'); else document.body.setAttribute('data-theme','dark'); });
  sizeSel.addEventListener('change',()=>{ N = 4 + sizeSel.selectedIndex; localStorage.setItem('size2048',String(N)); start(true); });
  hardcoreCb.addEventListener('change',()=>{ hardcore=hardcoreCb.checked; localStorage.setItem('hardcore2048',hardcore?'1':'0'); btnUndo.style.opacity=hardcore?.5:1; btnUndo.style.pointerEvents=hardcore?'none':'auto'; showToast(hardcore?'–•–∞—Ä–¥–∫–æ—Ä üíÄ':'–°—Ç–∞–Ω–¥–∞—Ä—Ç ‚úÖ'); });

  /* ===== –ê–¥–∞–ø—Ç–∏–≤: –ø–æ–ª–µ –±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ ===== */
  function fit(){
    const headerH=document.querySelector('header').offsetHeight + document.querySelector('.brand').offsetHeight;
    const footerH=document.querySelector('footer').offsetHeight;
    const vSpace=window.innerHeight - headerH - footerH - 18;
    const hSpace=window.innerWidth - 20;
    const size=Math.max(280, Math.min(hSpace, vSpace));
    wrap.style.maxWidth = size + 'px';
    wrap.style.aspectRatio = '1 / 1';
    computeSizes(); if(grid) mountTiles(grid);
  }
  window.addEventListener('resize', fit);

  function start(fresh=false){
    fit();
    grid=Array.from({length:N},()=>Array(N).fill(null)); score=0; prevState=null; idSeq=1; tilesEl.innerHTML='';
    addRandomTile(grid); addRandomTile(grid);
    best=+localStorage.getItem(`best2048_${N}`)||0; bestEl.textContent=best;
    mountTiles(grid); if(fresh) showToast('–ù–æ–≤–∞—è –∏–≥—Ä–∞');
    btnUndo.style.opacity=hardcore?.5:1; btnUndo.style.pointerEvents=hardcore?'none':'auto';
  }

  window.addEventListener('DOMContentLoaded', ()=>{ setTimeout(()=>{ start(); }, 0); });
})();
</script>

<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').then(function(reg) {
        console.log('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', reg);
    }).catch(function(err) {
        console.log('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker', err);
    });
}
</script>


<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js').then(function(reg) {
        console.log('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', reg);
    }).catch(function(err) {
        console.log('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker', err);
    });
}
</script>


<script>
function wobbleAllTiles() {
  document.querySelectorAll('.tile').forEach(tile => {
    tile.classList.add('wobble');
    setTimeout(() => tile.classList.remove('wobble'), 350);
  });
}

function wobbleMergedTile(tileElem) {
  tileElem.classList.add('merge-wobble');
  setTimeout(() => tileElem.classList.remove('merge-wobble'), 450);
}

// –•—É–∫ –Ω–∞ —Å–≤–∞–π–ø
const originalMove = window.GameManager.prototype.move;
window.GameManager.prototype.move = function(direction) {
  wobbleAllTiles();
  return originalMove.apply(this, arguments);
};

// –•—É–∫ –Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç —Å–ª–∏—è–Ω–∏—è
const originalAddTile = window.HTMLActuator.prototype.addTile;
window.HTMLActuator.prototype.addTile = function(tile) {
  originalAddTile.call(this, tile);
  if (tile.mergedFrom) {
    const tileElem = document.querySelector(`.tile-position-${tile.x+1}-${tile.y+1}`);
    if (tileElem) wobbleMergedTile(tileElem);
  }
};
</script>


<style id="wow-effects">
/* 1. –ü–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–ª–∏—Ç–æ–∫ */
.tile {
  transition: transform 0.45s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.3s, box-shadow 0.3s;
}

/* 2. –≠—Ñ—Ñ–µ–∫—Ç –ø–æ—è–≤–ª–µ–Ω–∏—è –ø–ª–∏—Ç–∫–∏ */
.tile.new-tile {
  animation: appear 0.4s ease-out;
}

/* 3. –≠—Ñ—Ñ–µ–∫—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –ø–ª–∏—Ç–æ–∫ */
.tile.merge-tile {
  animation: merge 0.35s ease-in-out;
}

/* 4. –õ—ë–≥–∫–æ–µ –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–ª–∏—Ç–æ–∫ –ø—Ä–∏ —Å–≤–∞–π–ø–µ */
@keyframes wobble {
  0%, 100% { transform: rotate(0deg); }
  25% { transform: rotate(1deg); }
  75% { transform: rotate(-1deg); }
}

/* 5. –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–∏ */
.tile.merge-tile {
  box-shadow: 0 0 20px rgba(255,255,0,0.6);
}

/* 6. –ú—è–≥–∫–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ */
@keyframes fadeOut {
  to { opacity: 0; transform: scale(0.9); }
}

/* 7. –≠—Ñ—Ñ–µ–∫—Ç –ø—É–ª—å—Å–∞ –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –±–æ–ª—å—à–æ–π –ø–ª–∏—Ç–∫–∏ */
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

/* 8. –õ—ë–≥–∫–∏–π –ø–æ–¥—ä—ë–º –ø–ª–∏—Ç–∫–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
.tile:hover {
  transform: translateY(-4px) scale(1.02);
}
@keyframes appear {
  0% { transform: scale(0); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}
@keyframes merge {
  0% { transform: scale(1); }
  50% { transform: scale(1.15); }
  100% { transform: scale(1); }
}
</style>

<script id="wow-logic">
document.addEventListener("tileMove", function(e) {
  e.detail.tileElem.style.animation = "wobble 0.35s ease-in-out";
  setTimeout(() => e.detail.tileElem.style.animation = "", 350);
});

document.addEventListener("tileMerge", function(e) {
  e.detail.tileElem.classList.add("merge-tile");
  setTimeout(() => e.detail.tileElem.classList.remove("merge-tile"), 350);
});

document.addEventListener("tileNew", function(e) {
  e.detail.tileElem.classList.add("new-tile");
  setTimeout(() => e.detail.tileElem.classList.remove("new-tile"), 400);
});
</script>


<script>
// === –ê–Ω–∏–º–∞—Ü–∏–∏ –∏–∑ WOW –≤–µ—Ä—Å–∏–∏ ===

(() => {
  const size = 4;
  const boardEl = document.getElementById('board');
  const scoreEl = document.getElementById('score');
  const bestEl  = document.getElementById('best');
  const newBtn  = document.getElementById('new');
  boardEl.style.setProperty('--board-size', size);

  let grid, score = 0, best = +localStorage.getItem('wow2048-best') || 0;
  bestEl.textContent = best.toLocaleString('ru-RU');

  const rnd = (n)=>Math.floor(Math.random()*n);
  const E = {Left:0, Right:1, Up:2, Down:3};

  function emptyGrid(){
    grid = Array.from({length:size}, () => Array.from({length:size}, () => null));
  }

  function eachCell(fn){
    for(let y=0;y<size;y++) for(let x=0;x<size;x++) fn(x,y,grid[y][x]);
  }

  function addRandomTile(){
    const empties = [];
    eachCell((x,y,v)=>{ if(!v) empties.push([x,y]) });
    if(!empties.length) return false;
    const [x,y] = empties[rnd(empties.length)];
    const value = Math.random() < 0.9 ? 2 : 4;
    const t = makeTile(x,y,value);
    t.classList.add('spawn','chain');
    t.style.setProperty('--delay', 0);
    grid[y][x] = t;
    return true;
  }

  function makeTile(x,y,value){
    const el = document.createElement('div');
    el.className = 'tile';
    el.dataset.v = value;
    el.textContent = value;
    el.style.setProperty('--x', x);
    el.style.setProperty('--y', y);
    el.style.setProperty('--w', Math.random() > .5 ? 1 : -1);
    boardEl.appendChild(el);
    return el;
  }

  function setPos(t,x,y){
    t.style.setProperty('--x', x);
    t.style.setProperty('--y', y);
  }

  function val(t){ return +t.dataset.v }

  function resetChainClasses(){
    boardEl.querySelectorAll('.tile').forEach(t => {
      t.classList.remove('spawn','merged','moving','chain');
      t.style.removeProperty('--delay');
    });
  }

  function slide(dir){
    boardEl.classList.add('wobble','bounce');
    setTimeout(()=>boardEl.classList.remove('wobble'), 480);
    setTimeout(()=>boardEl.classList.remove('bounce'), 620);

    const order = [];
    switch(dir){
      case E.Left: for(let y=0;y<size;y++) for(let x=0;x<size;x++) order.push([x,y]); break;
      case E.Right:for(let y=0;y<size;y++) for(let x=size-1;x>=0;x--) order.push([x,y]); break;
      case E.Up:   for(let x=0;x<size;x++) for(let y=0;y<size;y++) order.push([x,y]); break;
      case E.Down: for(let x=0;x<size;x++) for(let y=size-1;y>=0;y--) order.push([x,y]); break;
    }

    let moved = false, chainIndex = 0;
    resetChainClasses();

    const canMerge = Array.from({length:size}, ()=>Array(size).fill(true));

    const getNext = (x,y)=>{
      if(dir===E.Left)  return [x-1,y];
      if(dir===E.Right) return [x+1,y];
      if(dir===E.Up)    return [x,y-1];
      return [x,y+1];
    };

    for(const [sx,sy] of order){
      let t = grid[sy][sx];
      if(!t) continue;
      let x = sx, y = sy;
      let nx,ny;
      t.classList.add('moving','chain');
      t.style.setProperty('--delay', chainIndex++);

      while(true){
        [nx,ny] = getNext(x,y);
        if(nx<0||nx>=size||ny<0||ny>=size) break;
        const nt = grid[ny][nx];
        if(!nt){ x=nx; y=ny; continue; }
        if(val(nt)===val(t) && canMerge[ny][nx]){ // merge
          x = nx; y = ny;
        }
        break;
      }

      if(x===sx && y===sy) { t.classList.remove('moving'); continue; }
      moved = true;
      grid[sy][sx] = null;

      const target = grid[y][x];
      if(target && val(target)===val(t) && canMerge[y][x]){
        canMerge[y][x] = false;
        // animate move first, then merge
        setPos(t,x,y);
        const from = t;
        from.addEventListener('transitionend', function onEnd(e){
          if(e.propertyName!=='left' && e.propertyName!=='top') return;
          from.removeEventListener('transitionend', onEnd);
          const newVal = val(target)*2;
          score += newVal;
          scoreEl.textContent = score.toLocaleString('ru-RU');

          target.remove(); // old merged tile
          from.dataset.v = newVal;
          from.textContent = newVal;
          from.classList.remove('moving');
          from.classList.add('merged');
          grid[y][x] = from;
          maybeBest();
        }, {once:true});
      }else{
        grid[y][x] = t;
        setPos(t,x,y);
        t.addEventListener('transitionend', ()=>t.classList.remove('moving'), {once:true});
      }
    }

    setTimeout(()=>{
      // –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–µ—Ä–∏–∏ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –ø–ª–∏—Ç–∫—É –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–µ—Ü –∏–≥—Ä—ã
      if(moved){
        addRandomTile();
        if(isGameOver()) showToast("–ù–µ—Ç —Ö–æ–¥–æ–≤ üòµ");
      }
    }, parseInt(getComputedStyle(boardEl).getPropertyValue('--move-duration')) + 40);
  }

  function isGameOver(){
    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—É—Å—Ç—ã–µ ‚Äî –Ω–µ –∫–æ–Ω–µ—Ü
    for(let y=0;y<size;y++) for(let x=0;x<size;x++) if(!grid[y][x]) return false;
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å–µ–¥–µ–π –Ω–∞ merge
    for(let y=0;y<size;y++) for(let x=0;x<size;x++){
      const t = grid[y][x], v = val(t);
      if(x+1<size && val(grid[y][x+1])===v) return false;
      if(y+1<size && val(grid[y+1][x])===v) return false;
    }
    return true;
  }

  function maybeBest(){
    if(score>best){
      best = score; bestEl.textContent = best.toLocaleString('ru-RU');
      localStorage.setItem('wow2048-best', best);
    }
  }

  // ‚Äî‚Äî‚Äî UI / –≤–≤–æ–¥ ‚Äî‚Äî‚Äî
  function start(){
    boardEl.innerHTML = '';
    emptyGrid();
    score = 0; scoreEl.textContent = '0';
    boardEl.classList.remove('wobble','bounce');

    // –æ—Ç—Ä–∏—Å—É–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –∫–ª–µ—Ç–∫–∏ –¥–ª—è —Å–µ—Ç–∫–∏
    const frag = document.createDocumentFragment();
    for(let i=0;i<size*size;i++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      frag.appendChild(cell);
    }
    boardEl.appendChild(frag);

    addRandomTile();
    addRandomTile();
  }
  newBtn.addEventListener('click', start);

  // –ö–ª–∞–≤–∏—à–∏
  window.addEventListener('keydown', e=>{
    if(['ArrowLeft','KeyA'].includes(e.code)) { e.preventDefault(); slide(E.Left); }
    if(['ArrowRight','KeyD'].includes(e.code)) { e.preventDefault(); slide(E.Right); }
    if(['ArrowUp','KeyW'].includes(e.code)) { e.preventDefault(); slide(E.Up); }
    if(['ArrowDown','KeyS'].includes(e.code)) { e.preventDefault(); slide(E.Down); }
  }, {passive:false});

  // –°–≤–∞–π–ø—ã
  let tx=0, ty=0;
  boardEl.addEventListener('touchstart',e=>{
    const t = e.changedTouches[0]; tx=t.clientX; ty=t.clientY;
  }, {passive:true});
  boardEl.addEventListener('touchend',e=>{
    const t = e.changedTouches[0], dx=t.clientX-tx, dy=t.clientY-ty;
    const ax=Math.abs(dx), ay=Math.abs(dy);
    if(Math.max(ax,ay)<18) return;
    if(ax>ay) slide(dx>0?E.Right:E.Left); else slide(dy>0?E.Down:E.Up);
  }, {passive:true});

  // –õ—ë–≥–∫–∏–π —Ç–æ—Å—Ç
  let toastEl;
  function showToast(text){
    if(!toastEl){
      toastEl = document.createElement('div');
      Object.assign(toastEl.style, {
        position:'fixed', left:'50%', bottom:'24px', transform:'translateX(-50%)',
        padding:'12px 16px', borderRadius:'12px',
        background:'rgba(255,255,255,.1)', color:'#fff', border:'1px solid rgba(255,255,255,.16)',
        backdropFilter:'blur(6px)', font:'600 14px/1.2 var(--tile-font)', boxShadow:'0 10px 30px rgba(0,0,0,.35)',
        opacity:'0', transition:'opacity .3s ease'
      });
      document.body.appendChild(toastEl);
    }
    toastEl.textContent = text;
    toastEl.style.opacity = '1';
    setTimeout(()=>toastEl.style.opacity='0', 1600);
  }

  start();
})();

</script>
</body>
</html>