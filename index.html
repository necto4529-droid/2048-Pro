<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>2048 Pro — полная версия</title>
<meta name="theme-color" content="#f2b179">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<style>
  :root{
    --bg:#f6f2e9; --panel:#ffffff; --grid:#cbbfb3; --cell:#d6ccc2;
    --text:#5a524a; --muted:#8f877f; --chip:#efe7dd; --chipText:#4e453e;
    --shadow:0 8px 22px rgba(0,0,0,.12); --border:rgba(0,0,0,.08);
    --overlay: rgba(20,16,10,.45);
    --accent1:#ffb24a; --accent2:#ff9500;
  }
  [data-theme="dark"]{
    --bg:#0b0f1a; --panel:#101627; --grid:#151b36; --cell:#11162f;
    --text:#e8ebff; --muted:#9aa4bf; --chip:#151c32; --chipText:#e8ebff;
    --shadow:0 10px 30px rgba(0,0,0,.35); --border:rgba(255,255,255,.08);
    --overlay: rgba(0,0,0,.55);
    --accent1:#ffb24a; --accent2:#ff9500;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1200px 600px at 10% -10%, var(--panel) 0%, var(--bg) 60%, var(--bg) 100%);
    color:var(--text); font-family:-apple-system, Segoe UI, Roboto, Inter, Arial, system-ui, sans-serif;
    -webkit-tap-highlight-color:transparent; overscroll-behavior:none;
  }

  .brand{max-width:920px; margin:10px auto 4px; padding:0 10px; display:flex; align-items:center; gap:10px}
  .logo{width:28px;height:28px;display:inline-block;filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
  .title{font-size:28px;font-weight:900;letter-spacing:.2px}
  .pill{margin-left:6px;padding:2px 10px;border-radius:999px;font-size:14px;font-weight:800;color:#3a2a00;
        background:linear-gradient(135deg,var(--accent1),var(--accent2));box-shadow:0 4px 12px rgba(255,153,0,.35),inset 0 1px 0 rgba(255,255,255,.6)}

  header{max-width:920px;margin:0 auto;padding:6px 10px;position:relative}
  .menu{display:flex;flex-direction:column;gap:6px}
  .row{display:flex;gap:6px;align-items:center}
  .grow{flex:1}
  .btn,.select,.stat{
    border:1px solid var(--border);background:var(--panel);color:var(--text);
    padding:8px 10px;border-radius:10px;font-weight:700;box-shadow:var(--shadow);
    display:flex;align-items:center;justify-content:center;white-space:nowrap;min-height:36px
  }
  .btn:active{transform:translateY(1px)}
  .select{padding:0 10px}
  .select select{appearance:none;background:transparent;border:0;padding:8px 0;font:inherit;color:inherit}
  .stat{justify-content:space-between;padding:6px 10px;font-weight:800}
  .stat small{opacity:.75;font-weight:700}

  /* Floating Pause button higher than first row */
  .pause-fab{
    position:absolute; right:10px; top:-38px;
    width:46px; height:46px; border-radius:12px;
    background:linear-gradient(135deg,#ffb24a,#ff9500);
    border:none; display:grid; place-items:center;
    box-shadow:0 10px 26px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.65);
    cursor:pointer; z-index:4; color:#fff; font-size:20px; font-weight:900;
  }
  .pause-fab:active{transform:scale(.97)}

  main{max-width:920px;margin:0 auto;padding:6px 10px 12px;display:grid;place-items:center;position:relative}
  .wrap{
    width:100%;max-width:620px;aspect-ratio:1/1;position:relative;padding:10px;
    background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow)
  }
  .grid{position:absolute;inset:10px;padding:8px;background:var(--grid);border-radius:12px;display:grid;gap:8px}
  .cell{background:var(--cell);border-radius:9px;box-shadow: inset 0 1px 0 rgba(255,255,255,.28)}
  [data-theme="dark"] .cell{box-shadow: inset 0 1px 0 rgba(255,255,255,.06)}
  .tiles{position:absolute;inset:18px;pointer-events:none}
  .toast{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(.95);background:rgba(0,0,0,.35);
         padding:10px 12px;border-radius:10px;color:#fff;box-shadow:var(--shadow);opacity:0;transition:.15s;pointer-events:none;font-size:14px}
  .toast.show{opacity:1;transform:translate(-50%,-50%) scale(1)}

  /* Tile visuals */
  .tile{
    position:absolute; display:flex; align-items:center; justify-content:center; user-select:none;
    width:var(--cellw); height:var(--cellh); border-radius:10px; font-weight:900; font-size:28px;
    transform: translate(var(--x), var(--y)) scale(1); transition: transform .45s cubic-bezier(0.25,1,0.5,1);
    color:#776e65; background:#eee4da;
    box-shadow:0 14px 28px rgba(0,0,0,.18), 0 4px 10px rgba(0,0,0,.12), inset 0 1px 2px rgba(255,255,255,.55);
  }
  .tile.pop{animation:pop .14s ease-out both}
  @keyframes pop{0%{transform:translate(var(--x),var(--y)) scale(.85)}100%{transform:translate(var(--x),var(--y)) scale(1)}}
  .v2{background:#eee4da;color:#776e65}.v4{background:#ede0c8;color:#776e65}
  .v8{background:#f2b179;color:#f9f6f2}.v16{background:#f59563;color:#f9f6f2}
  .v32{background:#f67c5f;color:#f9f6f2}.v64{background:#f65e3b;color:#f9f6f2}
  .v128{background:#edcf72;color:#f9f6f2;font-size:24px}.v256{background:#edcc61;color:#f9f6f2;font-size:24px}
  .v512{background:#edc850;color:#f9f6f2;font-size:24px}.v1024{background:#edc53f;color:#f9f6f2;font-size:22px}
  .v2048{background:#edc22e;color:#f9f6f2;font-size:22px}.v4096,.v8192{background:#3c3a32;color:#f9f6f2;font-size:22px}

  footer{padding:8px 10px 12px;color:var(--muted);font-size:12px;text-align:center}

  @media (max-width:420px){
    .btn,.select,.stat{min-height:34px;padding:6px 8px;font-size:13px}
    .tile{font-size:24px}
  }

  /* ===== Screens (Главное меню / Настройки) ===== */
  .screen{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:var(--bg); z-index:20; opacity:0; visibility:hidden;
    transition:opacity .25s ease, visibility .25s ease;
  }
  .screen.show{opacity:1; visibility:visible}
  .menu-card{
    width:min(460px,92vw);
    padding:24px 18px 28px;
    border-radius:20px;
    background:var(--panel);
    box-shadow:0 20px 60px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.5);
    border:1px solid var(--border);
    text-align:center;
    opacity:0;
    transform:translateY(80px);
  }
  .screen.show .menu-card{
    opacity:1;
    animation:bounceIn .55s cubic-bezier(.25,1.25,.5,1) forwards;
  }
  .menu-title{font-size:42px; font-weight:900; margin:10px 0 16px}
  .menu-title .pro{color:var(--accent1)}
  .bigbtn{
    width:100%; padding:14px 16px; border-radius:14px; border:1px solid var(--border);
    background:#efe7dd; color:#3d352f; font-weight:800; font-size:18px; margin:10px 0;
    box-shadow:0 10px 30px rgba(0,0,0,.08); cursor:pointer;
  }
  .bigbtn:active{transform:translateY(1px)}
  .smallmuted{color:var(--muted);font-size:12px;margin-top:6px}

  /* Пауза модал */
  .overlay{position:fixed; inset:0; background:var(--overlay); display:flex; align-items:center; justify-content:center; z-index:25; opacity:0; visibility:hidden; transition:opacity .2s ease, visibility .2s ease;}
  .overlay.show{opacity:1; visibility:visible}
  .dialog{
    width:min(380px,88vw);
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:20px;
    padding:18px 16px 20px;
    box-shadow:0 25px 80px rgba(0,0,0,.25);
    opacity:0;
    transform:scale(.9) translateY(20px);
  }
  .overlay.show .dialog{
    opacity:1;
    animation:pauseBounce .45s cubic-bezier(.25,1.25,.5,1) forwards;
  }
  .dialog h3{font-size:28px;margin:4px 0 12px;text-align:center}
  .dialog .dlgbtn{display:block;width:100%;padding:14px 14px;border-radius:14px;border:1px solid var(--border);background:#efe7dd;color:#3d352f;font-weight:800;font-size:18px;margin:10px 0}

  /* Settings layout */
  .set-item{
    display:flex;align-items:center;justify-content:space-between;
    border:1px solid var(--border);background:var(--panel);
    padding:14px 16px;border-radius:14px;margin:10px 0;
    box-shadow:0 6px 18px rgba(0,0,0,.08)
  }
  .set-item label{font-weight:800}
  .set-actions{display:flex;gap:10px;margin-top:10px}
  .set-actions .btn{flex:1}

  /* Goal panel styles */
  .goal-panel{
    margin:20px auto;
    max-width:420px;
    padding:16px;
    border-radius:18px;
    background:linear-gradient(145deg, #2a2a2a, #1c1c1c);
    box-shadow:0 8px 20px rgba(0,0,0,0.6), inset 0 2px 6px rgba(255,255,255,0.05);
    text-align:center;
  }
  .goal-title{
    font-size:18px;
    font-weight:700;
    margin-bottom:10px;
    color:var(--text);
  }
  .goal-bar{
    width:100%;
    height:20px;
    border-radius:12px;
    background:#333;
    overflow:hidden;
    box-shadow:inset 0 2px 5px rgba(0,0,0,0.8);
  }
  .goal-fill{
    height:100%;
    width:0%;
    border-radius:12px;
    background:linear-gradient(90deg, #ffb347, #ff7f50);
    box-shadow:0 0 12px rgba(255,140,0,0.7);
    transition:width .5s ease;
  }

  .goal-fill.animate{
    animation:pulseFill .6s ease;
  }
  @keyframes pulseFill{
    0%{transform:scaleY(1);}
    40%{transform:scaleY(1.3);}
    100%{transform:scaleY(1);}
  }


  .goal-panel.glow{
    animation:goalGlow 1s ease;
  }
  @keyframes goalGlow{
    0%{box-shadow:0 0 0 rgba(255,165,0,0);}
    40%{box-shadow:0 0 25px rgba(255,165,0,0.9);}
    100%{box-shadow:0 8px 20px rgba(0,0,0,0.6), inset 0 2px 6px rgba(255,255,255,0.05);}
  }


#goalPanel {
  width: 90%;
  margin: 0 auto;
}

/* ===== Splash Screen ===== */
#splashScreen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: radial-gradient(circle at center, #000 0%, #111 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  
  
}
#splashScreen.hide { display: none; }
#splashLogo {
  width: 180px;
  opacity: 0;
  transform: translateY(150px) scale(0.8) rotateX(30deg);
  filter: drop-shadow(0 0 15px rgba(255, 200, 50, 0.7));
  animation: logoFly 2s ease forwards, logoGlow 1.5s ease-in-out infinite alternate;
}
@keyframes logoFly {
  0% { opacity: 0; transform: translateY(150px) scale(0.8) rotateX(30deg); }
  60% { opacity: 1; transform: translateY(-20px) scale(1.05) rotateX(-10deg); }
  80% { transform: translateY(0) scale(0.95) rotateX(5deg); }
  100% { transform: translateY(0) scale(1) rotateX(0deg); }
}
@keyframes logoGlow {
  from { filter: drop-shadow(0 0 10px rgba(255,200,50,0.4)); }
  to   { filter: drop-shadow(0 0 25px rgba(255,200,50,1)); }
}
@keyframes fadeOut {
  to { opacity: 0; visibility: hidden; }
}


#splashHint {
  color: #ffd86b;
  font-size: 1.2em;
  font-weight: 600;
  margin-top: 20px;
  text-shadow: 0 0 8px rgba(255, 200, 50, 0.8);
  animation: hintBlink 1.5s infinite;
}
@keyframes hintBlink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}


#splashLogo {
  animation: logoBreath 3s ease-in-out infinite;
}

@keyframes logoBreath {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

</style>
</head>
<body>

<div id="splashScreen">
  <img src="icon-512.png" alt="2048 Pro" id="splashLogo">

  <p id="splashHint">Нажмите, чтобы начать</p>

</div>


<!-- Брендинг -->
<div class="brand" aria-hidden="true">
  <svg class="logo" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
    <defs><radialGradient id="g" cx="50%" cy="50%" r="50%">
      <stop offset="0" stop-color="#ff6a6a"/><stop offset="1" stop-color="#e51d2d"/>
    </radialGradient></defs>
    <circle cx="24" cy="24" r="22" fill="url(#g)"/>
    <circle cx="24" cy="24" r="15" fill="#fff" opacity=".9"/>
    <circle cx="24" cy="24" r="9" fill="url(#g)"/>
    <circle cx="24" cy="24" r="3.2" fill="#fff"/>
  </svg>
  <div class="title">2048 <span class="pill">Pro</span></div>
</div>

<header>
  <!-- Кнопка паузы закреплена выше первой строки -->
  <button class="pause-fab" id="pauseFab" aria-label="Пауза">⏸</button>

  <div class="menu">
    <!-- Первая строка: Отменить, Размер, Новая -->
    <div class="row">
      <button id="undo" class="btn grow" title="Отменить ход">↩ Отменить</button>
      <div class="select grow">
        <label>Размер:
          <select id="sizeSel" aria-label="Размер поля"><option>4×4</option><option>5×5</option><option>6×6</option></select>
        </label>
      </div>
      <button id="newGame" class="btn grow" title="Начать заново">↻ Новая</button>
    </div>
    <!-- Вторая строка: счёт -->
    <div class="row">
      <div class="stat grow"><small>Очки</small><span id="score">0</span></div>
      <div class="stat grow"><small>Рекорд</small><span id="best">0</span></div>
    </div>
  </div>
</header>

<main>
  <div class="wrap" id="wrap">
    <div class="grid" id="grid" aria-hidden="true"></div>
    <div class="tiles" id="tiles" role="grid" aria-label="Поле 2048"></div>
    <div class="toast" id="toast">Игра окончена</div>
  </div>
</main>

<footer>2048 Pro © 2014–2025 Ray_Production. Все права защищены.</footer>

<!-- ===== Главное меню ===== -->
<section id="mainMenu" class="screen show" aria-modal="true" role="dialog">
  <div class="menu-card">
    <div class="menu-title">2048 <span class="pro">Pro</span></div>
    <button class="bigbtn" id="startBtn">Играть</button>
    <button class="bigbtn" id="settingsFromMain">Настройки</button>
    <button class="bigbtn" id="exitBtn">Выход</button>
    <div class="smallmuted">Версия для браузера</div>
  </div>
</section>

<!-- ===== Настройки ===== -->
<section id="settingsScreen" class="screen" aria-modal="true" role="dialog">
  <div class="menu-card" style="padding:18px 18px 22px">
    <div class="menu-title" style="font-size:32px;margin:8px 0 6px">Настройки</div>
    <div class="set-item"><label for="sfxToggle">Звук</label><input id="sfxToggle" type="checkbox"></div>
    <div class="set-item"><label for="vibToggle">Вибрация</label><input id="vibToggle" type="checkbox"></div>
    <div class="set-item">
      <label for="themeSel">Тема</label>
      <select id="themeSel">
        <option value="auto">Системная</option>
        <option value="light">Светлая</option>
        <option value="dark">Тёмная</option>
      </select>
    </div>
    <div class="set-item"><label for="musicToggle">Музыка</label><input id="musicToggle" type="checkbox"></div>
    <div class="set-item"><label for="hardcore">Хардкор (без отмены)</label><input id="hardcore" type="checkbox"></div>
    <div class="set-actions">
      <button class="btn" id="settingsBack">Назад</button>
      <button class="btn" id="settingsOk">Сохранить</button>
    </div>
  </div>
</section>

<!-- ===== Пауза ===== -->
<div id="pauseOverlay" class="overlay" role="dialog" aria-modal="true">
  <div class="dialog">
    <h3>Пауза</h3>
    <button class="dlgbtn" id="resumeBtn">Продолжить</button>
    <button class="dlgbtn" id="settingsFromPause">Настройки</button>
    <button class="dlgbtn" id="toMainBtn">Главное меню</button>
  </div>
</div>

<!-- ===== Consent (как в прошлой версии) ===== -->
<div id="consent-screen" style="position: fixed;inset:0;background: rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index: 1000">
  <div style="background:#ffffff;padding:30px;border-radius:12px;text-align:center;max-width:400px;width:90%;font-family:Arial, sans-serif;">
    <h2 style="margin-bottom: 15px; color:#333;">Добро пожаловать в 2048 Pro!</h2>
    <p style="margin-bottom: 20px; font-size:16px; color:#555;">
      Продолжая, вы соглашаетесь с нашей
      <a href='https://necto4529-droid.github.io/Privacy-2048-Pro/' target='_blank'>Политикой конфиденциальности</a>.
    </p>
    <button onclick="acceptConsent()" style="background:#ff7a00;color:#fff;border:none;padding:12px 24px;border-radius:8px;font-size:16px;cursor:pointer;transition:background .3s;">Согласен</button>
  </div>
</div>

<script>
function acceptConsent(){ localStorage.setItem('consentGiven','true'); document.getElementById('consent-screen').style.display='none'; }
window.addEventListener('load',()=>{ if(localStorage.getItem('consentGiven')==='true') document.getElementById('consent-screen').style.display='none'; });

// --- Goal Progress System ---
let nextGoalValue = 64;

function resetGoal(){
  try{
    nextGoalValue = 64;
    var nextEl = document.getElementById('nextGoal');
    if(nextEl) nextEl.textContent = nextGoalValue;
    var fill = document.getElementById('goalProgress');
    if(fill){
      fill.style.width = '0%';
      fill.classList.remove('animate');
    }
    var panel = document.getElementById('goalPanel');
    if(panel) panel.classList.remove('glow');
  }catch(e){}
}
function updateGoalPanel(){
  const goalPanel=document.getElementById('goalPanel');
  // найти максимальную плитку на поле
  let tiles = document.querySelectorAll('.tile');
  let maxVal = 2;
  tiles.forEach(t=>{
    let v=parseInt(t.textContent)||0;
    if(v>maxVal) maxVal=v;
  });
  if(maxVal >= nextGoalValue){
    while(maxVal >= nextGoalValue){ nextGoalValue *= 2; }
    document.getElementById('nextGoal').textContent = nextGoalValue;
    // trigger glow effect
    goalPanel.classList.remove('glow');
    void goalPanel.offsetWidth;
    goalPanel.classList.add('glow'); try{ playRandomGoalSound(); }catch(e){}
  }
  let progress = (maxVal/(nextGoalValue))*100;
  if(progress>100) progress=100;
  let fill=document.getElementById('goalProgress');
  fill.style.width=progress+'%';
  fill.classList.remove('animate');
  void fill.offsetWidth; // restart animation
  fill.classList.add('animate');
}


// --- Goal sounds ---
const goalSounds = [
  document.getElementById('soundBling'),
  document.getElementById('soundFanfare'),
  document.getElementById('soundDrum')
];
function playRandomGoalSound(){
  const s = goalSounds[Math.floor(Math.random()*goalSounds.length)];
  if(s){ s.currentTime=0; s.play().catch(()=>{}); }
}


// Splash screen auto-hide
window.addEventListener('load', () => {
  setTimeout(() => {
    const splash = document.getElementById('splashScreen');
    
  }, 3500);
});


// Splash screen hide on click/tap
window.addEventListener('load', () => {
  const splash = document.getElementById('splashScreen');
  if(splash){
    splash.addEventListener('click', () => {
      
    });
  }
});


// Splash closes ONLY on click/tap now (autohide removed)
window.addEventListener('load', () => {
  const splash = document.getElementById('splashScreen');
  if(splash){
    splash.classList.remove('hide');
    splash.addEventListener('click', () => {
      splash.classList.add('hide');
    });
  }
});

</script>

<script>
(()=>{
  /* ===== DOM ===== */
  const tilesEl=document.getElementById('tiles'), gridBg=document.getElementById('grid'), wrap=document.getElementById('wrap');
  const scoreEl=document.getElementById('score'), bestEl=document.getElementById('best'), toast=document.getElementById('toast');
  const btnNew=document.getElementById('newGame'), btnUndo=document.getElementById('undo');
  const sizeSel=document.getElementById('sizeSel');
  // overlays
  const mainMenu=document.getElementById('mainMenu');
  const settingsScreen=document.getElementById('settingsScreen');
  const pauseOverlay=document.getElementById('pauseOverlay');
  const pauseFab=document.getElementById('pauseFab');
  const startBtn=document.getElementById('startBtn');
  const settingsFromMain=document.getElementById('settingsFromMain');
  const exitBtn=document.getElementById('exitBtn');
  const resumeBtn=document.getElementById('resumeBtn');
  const settingsFromPause=document.getElementById('settingsFromPause');
  const toMainBtn=document.getElementById('toMainBtn');

  // settings widgets
  const sfxToggle=document.getElementById('sfxToggle');
  const vibToggle=document.getElementById('vibToggle');
  const themeSel=document.getElementById('themeSel');
  const settingsBack=document.getElementById('settingsBack');
  const settingsOk=document.getElementById('settingsOk');
  const musicToggle=document.getElementById('musicToggle');
  const hardcoreCb=document.getElementById('hardcore');

  /* ===== Settings state ===== */
  let N = +(localStorage.getItem('size2048')||4);
  sizeSel.selectedIndex = Math.max(0, Math.min(2, N-4));
  let hardcore = localStorage.getItem('hardcore2048')==='1';
  hardcoreCb.checked = hardcore;

  // theme preference
  function applyThemePref(){
    const pref=localStorage.getItem('themePref')||'auto';
    themeSel.value=pref;
    const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const dark = pref==='dark' || (pref==='auto' && sysDark);
    if(dark) document.body.setAttribute('data-theme','dark'); else document.body.removeAttribute('data-theme');
  }
  applyThemePref();

  /* ===== Audio / Haptics / Music ===== */
  let actx, musicOn = localStorage.getItem('musicOn')==='1';
  let sfxOn = localStorage.getItem('sfxOn')!=='0';
  let vibOn = localStorage.getItem('vibOn')==='1';
  sfxToggle.checked=sfxOn; vibToggle.checked=vibOn; musicToggle.checked = musicOn;

  function ensureAudio(){ try{ if(!actx) actx=new (window.AudioContext||window.webkitAudioContext)(); }catch{} }
  function beep({f=440,d=0.06,t='sine',v=0.06}={}){ if(!sfxOn) return; try{ ensureAudio(); const o=actx.createOscillator(), g=actx.createGain(); o.type=t;o.frequency.value=f;g.gain.value=v;o.connect(g);g.connect(actx.destination);o.start();g.gain.exponentialRampToValueAtTime(0.0001,actx.currentTime+d);o.stop(actx.currentTime+d);}catch{} }
  const sMove=()=>beep({f:300,d:.05,t:'square',v:.03});
  const sMerge=()=>beep({f:520,d:.08,t:'triangle',v:.05});
  const sOver=()=>beep({f:180,d:.12,t:'sawtooth',v:.06});
  const sWin =()=>{beep({f:660,d:.12}); setTimeout(()=>beep({f:880,d:.12,v:.06}),110)};
  const hv = (ms=12)=>{ if(!vibOn||!navigator.vibrate) return; navigator.vibrate(ms); };

  function stopMusic(){ musicOn=false; localStorage.setItem('musicOn','0'); }
  function playMusic(){
    ensureAudio();
    musicOn=true; localStorage.setItem('musicOn','1');
    const bpm=96, beat=60/bpm;
    let cancelled=false; const startAt=actx.currentTime+0.05;
    function scheduleBlock(at){
      if(!musicOn){ cancelled=true; return; }
      const g=actx.createGain(); g.gain.value=0.06; g.connect(actx.destination);
      const scale=[261.63,329.63,392,523.25];
      for(let i=0;i<8;i++){
        const o=actx.createOscillator(), env=actx.createGain();
        o.type='triangle'; o.frequency.value=scale[i%scale.length];
        o.connect(env); env.connect(g);
        const st=at+i*beat; env.gain.setValueAtTime(0.0001,st);
        env.gain.exponentialRampToValueAtTime(0.12,st+0.01);
        env.gain.exponentialRampToValueAtTime(0.0001,st+beat*0.95);
        o.start(st); o.stop(st+beat*0.96);
      }
      if(!cancelled) setTimeout(()=>scheduleBlock(at+8*beat), (8*beat-0.02)*1000);
    }
    scheduleBlock(startAt);
  }
  if(musicOn) playMusic();
  musicToggle.addEventListener('change', ()=>{ if(musicToggle.checked) playMusic(); else stopMusic(); });

  ['touchstart','mousedown','keydown'].forEach(ev=>window.addEventListener(ev,()=>ensureAudio(),{once:true,passive:true}));

  /* ===== Game core ===== */
  const animMs=450;
  let grid, score=0, best=0, prevState=null, idSeq=1, paused=false, inMenu=true;

  const keyMap={ArrowLeft:'left',a:'left',A:'left',ArrowRight:'right',d:'right',D:'right',ArrowUp:'up',w:'up',W:'up',ArrowDown:'down',s:'down',S:'down'};
  const emptyGrid=()=>Array.from({length:N},()=>Array(N).fill(null));
  const copyGrid=g=>g.map(r=>r.map(t=>t?{...t}:null));
  const gridsEqual=(a,b)=>a.flat().map(t=>t?.value||0).join(',')===b.flat().map(t=>t?.value||0).join(',');
  const bestKey=()=>`best2048_${N}`;

  function computeSizes(){
    gridBg.style.gridTemplateColumns=`repeat(${N},1fr)`; gridBg.style.gridTemplateRows=`repeat(${N},1fr)`; gridBg.innerHTML='';
    for(let i=0;i<N*N;i++){ const c=document.createElement('div'); c.className='cell'; gridBg.appendChild(c); }
    const gap=8, w=tilesEl.clientWidth, h=tilesEl.clientHeight; const cw=(w-gap*(N-1))/N, ch=(h-gap*(N-1))/N;
    tilesEl.style.setProperty('--cellw',cw+'px'); tilesEl.style.setProperty('--cellh',ch+'px');
  }
  function posToPx(x,y){ const gap=8, w=tilesEl.clientWidth, h=tilesEl.clientHeight; const cw=(w-gap*(N-1))/N, ch=(h-gap*(N-1))/N; return [(cw+gap)*x,(ch+gap)*y]; }
  const tileClass=v=> v>=8192?'v8192': v>=4096?'v4096': 'v'+v;

  function mountTiles(g){
    const old=new Map([...tilesEl.children].map(el=>[+el.dataset.id,el])); const next=new Map();
    for(let y=0;y<N;y++)for(let x=0;x<N;x++){
      const t=g[y][x]; if(!t) continue; const id=t.id; let el=old.get(id); const [px,py]=posToPx(x,y);
      if(!el){ el=document.createElement('div'); el.className=`tile ${tileClass(t.value)} pop`; el.dataset.id=id; el.dataset.v=t.value; el.textContent=t.value;
        el.style.setProperty('--x',px+'px'); el.style.setProperty('--y',py+'px'); tilesEl.appendChild(el); }
      else { if(+el.dataset.v!==t.value){ el.className=`tile ${tileClass(t.value)} pop`; el.dataset.v=t.value; el.textContent=t.value; }
             el.style.transition=`transform ${animMs}ms cubic-bezier(0.25,1,0.5,1)`; el.style.setProperty('--x',px+'px'); el.style.setProperty('--y',py+'px'); }
      next.set(id,el);
    }
    for(const [id,el] of old){ if(!next.has(id)){ el.style.transition=`transform ${animMs}ms ease, opacity ${animMs}ms ease`; el.style.opacity='0'; setTimeout(()=>el.remove(),animMs); } }
    scoreEl.textContent=score; if(score>(+localStorage.getItem(bestKey())||0)) localStorage.setItem(bestKey(),String(score));
    best=+localStorage.getItem(bestKey())||0; bestEl.textContent=best;
  }

  function addRandomTile(g){
    const empty=[]; for(let y=0;y<N;y++)for(let x=0;x<N;x++) if(!g[y][x]) empty.push([x,y]);
    if(!empty.length) return false; const [x,y]=empty[Math.floor(Math.random()*empty.length)];
    const fourProb=hardcore?0.5:0.1; g[y][x]={id:idSeq++, value: Math.random()<(1-fourProb)?2:4}; return true;
  }
  function slideRowLeft(row){
    const arr=row.filter(t=>t); let gained=0;
    for(let i=0;i<arr.length-1;i++){ if(arr[i]&&arr[i+1]&&arr[i].value===arr[i+1].value){ arr[i]={id:idSeq++,value:arr[i].value*2}; gained+=arr[i].value; arr[i+1]=null; i++; } }
    const compact=arr.filter(t=>t); while(compact.length<N) compact.push(null); return {row:compact,gained};
  }
  function rotate(g){ const r=Array.from({length:N},()=>Array(N).fill(null)); for(let y=0;y<N;y++)for(let x=0;x<N;x++) r[x][N-1-y]=g[y][x]?{...g[y][x]}:null; return r; }
  function anyMovesLeft(g){
    if(g.flat().some(t=>!t)) return true;
    for(let y=0;y<N;y++)for(let x=0;x<N-1;x++) if(g[y][x]&&g[y][x+1]&&g[y][x].value===g[y][x+1].value) return true;
    for(let y=0;y<N-1;y++)for(let x=0;x<N;x++) if(g[y][x]&&g[y+1][x]&&g[y][x].value===g[y+1][x].value) return true;
    return false;
  }
  const reached2048=g=>g.flat().some(t=>t&&t.value>=2048);

  function move(dir){
    if(paused||inMenu) return;
    const prev=copyGrid(grid); prevState={grid:prev,score};
    let g=copyGrid(grid), gained=0;
    if(dir==='right'){ g=g.map(r=>r.slice().reverse()); g=g.map(r=>{const s=slideRowLeft(r); gained+=s.gained; return s.row;}); g=g.map(r=>r.slice().reverse()); }
    if(dir==='left'){ g=g.map(r=>{const s=slideRowLeft(r); gained+=s.gained; return s.row;}); }
    if(dir==='up'){ g=rotate(rotate(rotate(g))); g=g.map(r=>{const s=slideRowLeft(r); gained+=s.gained; return s.row;}); g=rotate(g); }
    if(dir==='down'){ g=rotate(g); g=g.map(r=>{const s=slideRowLeft(r); gained+=s.gained; return s.row;}); g=rotate(rotate(rotate(g))); }
    if(gridsEqual(g,grid)) return;
    if(gained>0){ sMerge(); hv(10); } else { sMove(); }
    score+=gained; grid=g; mountTiles(grid); updateGoalPanel();
    setTimeout(()=>{ addRandomTile(grid); mountTiles(grid); updateGoalPanel();
      if(reached2048(grid)) sWin();
      if(!anyMovesLeft(grid)){ showToast('Игра окончена'); sOver(); }
    }, 80);
  }

  /* ===== Toast ===== */
  let toastTimer=null; function showToast(t){ toast.textContent=t; toast.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>toast.classList.remove('show'),1400); }

  /* ===== Input ===== */
  document.addEventListener('keydown',e=>{const d=keyMap[e.key]; if(!d) return; e.preventDefault(); move(d);},{passive:false});
  let touchStart=null;
  wrap.addEventListener('touchstart',e=>{const t=e.changedTouches[0]; touchStart={x:t.clientX,y:t.clientY};},{passive:true});
  wrap.addEventListener('touchend',e=>{ if(!touchStart) return; const t=e.changedTouches[0]; const dx=t.clientX-touchStart.x, dy=t.clientY-touchStart.y; const ax=Math.abs(dx), ay=Math.abs(dy); if(Math.max(ax,ay)<24) return; move(ax>ay?(dx>0?'right':'left'):(dy>0?'down':'up')); touchStart=null;},{passive:true});

  /* ===== Buttons/settings ===== */
  btnNew.addEventListener('click',()=>start(true));
  btnUndo.addEventListener('click',()=>{ if(hardcore||!prevState) return; grid=copyGrid(prevState.grid); score=prevState.score; mountTiles(grid); });
  sizeSel.addEventListener('change',()=>{ N = 4 + sizeSel.selectedIndex; localStorage.setItem('size2048',String(N)); start(true); });

  /* ===== Responsive board ===== */
  function fit(){
    const headerH=document.querySelector('header').offsetHeight + document.querySelector('.brand').offsetHeight;
    const footerH=document.querySelector('footer').offsetHeight;
    const vSpace=window.innerHeight - headerH - footerH - 18;
    const hSpace=window.innerWidth - 20;
    const size=Math.max(280, Math.min(hSpace, vSpace));
    wrap.style.maxWidth = size + 'px';
    wrap.style.aspectRatio = '1 / 1';
    computeSizes(); if(grid) mountTiles(grid);
  }
  window.addEventListener('resize', fit);

  function start(fresh=false){
    resetGoal(); fit();
    grid=Array.from({length:N},()=>Array(N).fill(null)); score=0; prevState=null; idSeq=1; tilesEl.innerHTML='';
    addRandomTile(grid); addRandomTile(grid);
    best=+localStorage.getItem(`best2048_${N}`)||0; bestEl.textContent=best;
    mountTiles(grid); updateGoalPanel(); if(fresh) showToast('Новая игра');
    updateUndoState();
  }

  function updateUndoState(){
    btnUndo.style.opacity=hardcore?.5:1; btnUndo.style.pointerEvents=hardcore?'none':'auto';
  }

  /* ===== Menu / Pause logic ===== */
  let pauseByUI=false;
  function openMain(){ inMenu=true; mainMenu.classList.add('show'); pauseOverlay.classList.remove('show'); paused=false; }
  function closeMain(){ inMenu=false; mainMenu.classList.remove('show'); }
  function openSettings(){ settingsScreen.classList.add('show'); }
  function closeSettings(){ settingsScreen.classList.remove('show'); }
  function openPause(){ paused=true; pauseByUI=true; pauseOverlay.classList.add('show'); }
  function closePause(){ paused=false; pauseByUI=false; pauseOverlay.classList.remove('show'); }

  startBtn.addEventListener('click', ()=>{ closeMain(); start(true); });
  settingsFromMain.addEventListener('click', openSettings);
  exitBtn.addEventListener('click', ()=>{
    showToast('Чтобы выйти — закройте вкладку');
    try{ window.close(); }catch(e){}
  });
  pauseFab.addEventListener('click', openPause);
  resumeBtn.addEventListener('click', closePause);
  settingsFromPause.addEventListener('click', ()=>{ closePause(); openSettings(); });
  toMainBtn.addEventListener('click', ()=>{ closePause(); openMain(); });

  // Settings save/restore
  settingsBack.addEventListener('click', closeSettings);
  settingsOk.addEventListener('click', ()=>{
    sfxOn = sfxToggle.checked; vibOn = vibToggle.checked;
    localStorage.setItem('sfxOn', sfxOn?'1':'0');
    localStorage.setItem('vibOn', vibOn?'1':'0');

    const newPref = themeSel.value;
    localStorage.setItem('themePref', newPref);
    applyThemePref();

    const musicWas = musicOn;
    if(musicToggle.checked && !musicOn) playMusic();
    if(!musicToggle.checked && musicOn) stopMusic();

    hardcore = hardcoreCb.checked;
    localStorage.setItem('hardcore2048', hardcore?'1':'0');
    updateUndoState();

    closeSettings();
  });

  // initial
  window.addEventListener('DOMContentLoaded', ()=>{ setTimeout(()=>{ start(); }, 0); });
})();

// Splash screen auto-hide
window.addEventListener('load', () => {
  setTimeout(() => {
    const splash = document.getElementById('splashScreen');
    
  }, 3500);
});


// Splash screen hide on click/tap
window.addEventListener('load', () => {
  const splash = document.getElementById('splashScreen');
  if(splash){
    splash.addEventListener('click', () => {
      
    });
  }
});


// Splash closes ONLY on click/tap now (autohide removed)
window.addEventListener('load', () => {
  const splash = document.getElementById('splashScreen');
  if(splash){
    splash.classList.remove('hide');
    splash.addEventListener('click', () => {
      splash.classList.add('hide');
    });
  }
});

</script>

  <div id="goalPanel" class="goal-panel">
    <div class="goal-title">Следующая цель: <span id="nextGoal">64</span></div>
    <div class="goal-bar">
      <div id="goalProgress" class="goal-fill"></div>
    </div>
  </div>


<audio id="soundBling" src="sounds/bling.mp3" preload="auto"></audio>
<audio id="soundFanfare" src="sounds/fanfare.mp3" preload="auto"></audio>
<audio id="soundDrum" src="sounds/drum.mp3" preload="auto"></audio>

</body>
</html>

<style>
.set-item input[type="checkbox"]{width:40px;height:20px;appearance:none;background:#ccc;border-radius:20px;position:relative;cursor:pointer;transition:.3s}
.set-item input[type="checkbox"]:checked{background:var(--accent1)}
.set-item input[type="checkbox"]::after{content:"";position:absolute;top:2px;left:2px;width:16px;height:16px;background:#fff;border-radius:50%;transition:.3s}
.set-item input[type="checkbox"]:checked::after{left:22px}
.set-item select{padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:var(--chip);font-weight:600;cursor:pointer}
.set-actions{display:flex;gap:10px;margin-top:14px}
.set-actions .btn{flex:1;background:linear-gradient(135deg,#ffb24a,#ff9500);color:#fff;font-weight:800;cursor:pointer;transition:transform .15s ease}
.set-actions .btn:active{transform:scale(.97)}

/* ===== Splash Screen ===== */
#splashScreen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: radial-gradient(circle at center, #000 0%, #111 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  
  
}
#splashScreen.hide { display: none; }
#splashLogo {
  width: 180px;
  opacity: 0;
  transform: translateY(150px) scale(0.8) rotateX(30deg);
  filter: drop-shadow(0 0 15px rgba(255, 200, 50, 0.7));
  animation: logoFly 2s ease forwards, logoGlow 1.5s ease-in-out infinite alternate;
}
@keyframes logoFly {
  0% { opacity: 0; transform: translateY(150px) scale(0.8) rotateX(30deg); }
  60% { opacity: 1; transform: translateY(-20px) scale(1.05) rotateX(-10deg); }
  80% { transform: translateY(0) scale(0.95) rotateX(5deg); }
  100% { transform: translateY(0) scale(1) rotateX(0deg); }
}
@keyframes logoGlow {
  from { filter: drop-shadow(0 0 10px rgba(255,200,50,0.4)); }
  to   { filter: drop-shadow(0 0 25px rgba(255,200,50,1)); }
}
@keyframes fadeOut {
  to { opacity: 0; visibility: hidden; }
}


#splashHint {
  color: #ffd86b;
  font-size: 1.2em;
  font-weight: 600;
  margin-top: 20px;
  text-shadow: 0 0 8px rgba(255, 200, 50, 0.8);
  animation: hintBlink 1.5s infinite;
}
@keyframes hintBlink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}


#splashLogo {
  animation: logoBreath 3s ease-in-out infinite;
}

@keyframes logoBreath {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

</style>

<style>
@keyframes bounceIn {
  0% { transform:translateY(80px) scale(.95); }
  60% { transform:translateY(-8px) scale(1.02); }
  80% { transform:translateY(4px) scale(.99); }
  100% { transform:translateY(0) scale(1); }
}

/* ===== Splash Screen ===== */
#splashScreen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: radial-gradient(circle at center, #000 0%, #111 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  
  
}
#splashScreen.hide { display: none; }
#splashLogo {
  width: 180px;
  opacity: 0;
  transform: translateY(150px) scale(0.8) rotateX(30deg);
  filter: drop-shadow(0 0 15px rgba(255, 200, 50, 0.7));
  animation: logoFly 2s ease forwards, logoGlow 1.5s ease-in-out infinite alternate;
}
@keyframes logoFly {
  0% { opacity: 0; transform: translateY(150px) scale(0.8) rotateX(30deg); }
  60% { opacity: 1; transform: translateY(-20px) scale(1.05) rotateX(-10deg); }
  80% { transform: translateY(0) scale(0.95) rotateX(5deg); }
  100% { transform: translateY(0) scale(1) rotateX(0deg); }
}
@keyframes logoGlow {
  from { filter: drop-shadow(0 0 10px rgba(255,200,50,0.4)); }
  to   { filter: drop-shadow(0 0 25px rgba(255,200,50,1)); }
}
@keyframes fadeOut {
  to { opacity: 0; visibility: hidden; }
}


#splashHint {
  color: #ffd86b;
  font-size: 1.2em;
  font-weight: 600;
  margin-top: 20px;
  text-shadow: 0 0 8px rgba(255, 200, 50, 0.8);
  animation: hintBlink 1.5s infinite;
}
@keyframes hintBlink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}


#splashLogo {
  animation: logoBreath 3s ease-in-out infinite;
}

@keyframes logoBreath {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

</style>

<style>
@keyframes pauseBounce {
  0% { transform:scale(.9) translateY(20px); opacity:0; }
  60% { transform:scale(1.05) translateY(-6px); opacity:1; }
  80% { transform:scale(.98) translateY(3px); }
  100% { transform:scale(1) translateY(0); }
}

/* ===== Splash Screen ===== */
#splashScreen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: radial-gradient(circle at center, #000 0%, #111 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  
  
}
#splashScreen.hide { display: none; }
#splashLogo {
  width: 180px;
  opacity: 0;
  transform: translateY(150px) scale(0.8) rotateX(30deg);
  filter: drop-shadow(0 0 15px rgba(255, 200, 50, 0.7));
  animation: logoFly 2s ease forwards, logoGlow 1.5s ease-in-out infinite alternate;
}
@keyframes logoFly {
  0% { opacity: 0; transform: translateY(150px) scale(0.8) rotateX(30deg); }
  60% { opacity: 1; transform: translateY(-20px) scale(1.05) rotateX(-10deg); }
  80% { transform: translateY(0) scale(0.95) rotateX(5deg); }
  100% { transform: translateY(0) scale(1) rotateX(0deg); }
}
@keyframes logoGlow {
  from { filter: drop-shadow(0 0 10px rgba(255,200,50,0.4)); }
  to   { filter: drop-shadow(0 0 25px rgba(255,200,50,1)); }
}
@keyframes fadeOut {
  to { opacity: 0; visibility: hidden; }
}


#splashHint {
  color: #ffd86b;
  font-size: 1.2em;
  font-weight: 600;
  margin-top: 20px;
  text-shadow: 0 0 8px rgba(255, 200, 50, 0.8);
  animation: hintBlink 1.5s infinite;
}
@keyframes hintBlink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}


#splashLogo {
  animation: logoBreath 3s ease-in-out infinite;
}

@keyframes logoBreath {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

</style>
